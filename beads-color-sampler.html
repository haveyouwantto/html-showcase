<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹¼è±†é¢œè‰²ä¼˜åŒ–é€‰æ‹©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #334155;
            --bg-input: #475569;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #475569;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            min-height: calc(100vh - 40px);
        }

        header {
            grid-column: 1 / -1;
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(30, 41, 59, 0.9);
            border-radius: 15px;
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        h1 {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .color-grid-container {
            background: rgba(30, 41, 59, 0.9);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--border);
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .color-grid-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent-primary);
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            overflow-y: auto;
            padding: 10px;
        }

        .color-card {
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            aspect-ratio: 1 / 1;
        }

        .color-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-primary);
            box-shadow: 0 8px 15px rgba(59, 130, 246, 0.3);
        }

        .color-box {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            position: relative;
        }

        .color-info {
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .color-code {
            font-family: sans;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .color-id {
            color: var(--text-muted);
            font-weight: bold;
            font-size: 16px;
        }

        .color-name {
            font-size: 12px;
            margin-bottom: 4px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .controls {
            background: rgba(30, 41, 59, 0.9);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .controls h2 {
            color: var(--accent-primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent-primary);
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        input,
        select,
        button {
            width: 100%;
            padding: 12px 15px;
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus,
        select:focus,
        button:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        button {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-top: 5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }

        button:disabled {
            background: var(--border);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .display-controls {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .display-type {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .display-type input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        .progress-panel {
            background: rgba(30, 41, 59, 0.9);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--border);
            flex: 1;
        }

        .progress-panel h2 {
            color: var(--accent-primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent-primary);
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: var(--bg-input);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #34d399);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            color: var(--text-muted);
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .stat-box {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent-primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        .log-box {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .log-line {
            margin-bottom: 8px;
            padding: 8px 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            border-left: 3px solid var(--accent-primary);
        }

        .log-line.warning {
            border-left-color: var(--warning);
        }

        .log-line.success {
            border-left-color: var(--success);
        }

        .log-line.error {
            border-left-color: var(--danger);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 50px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--border);
            border-top: 5px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .fixed-color {
            position: relative;
        }

        .fixed-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            color: var(--bg-primary);
            font-size: 16px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: -1;
            }

            .color-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .display-controls {
                flex-direction: column;
                gap: 10px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .color-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }

        @media (max-width: 480px) {
            .color-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .current-color {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>ğŸ¨ æ‹¼è±†é¢œè‰²ä¼˜åŒ–é€‰æ‹©</h1>
            <p style="color: var(--text-secondary);">åŸºäºæ¨¡æ‹Ÿé€€ç«ç®—æ³•çš„é¢œè‰²é€‰æ‹©ä¼˜åŒ–ç³»ç»Ÿ</p>
        </header>

        <main class="main-content">
            <div class="color-grid-container">
                <div class="color-grid-header">
                    <h2 id="result-title">ğŸ¨ ä¼˜åŒ–ç»“æœ</h2>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="color: var(--text-muted);">å½“å‰é¢œè‰²æ•°: <span id="current-colors-count">0</span></span>
                        <button id="export-btn"
                            style="padding: 5px 15px; font-size: 14px; width: auto; background: var(--bg-card); border-color: var(--accent-primary);">å¯¼å‡ºç»“æœ</button>
                    </div>
                </div>

                <div id="image-preview-container"
                    style="display: none; margin-bottom: 20px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 10px; text-align: center;">
                    <h3 style="color: var(--text-secondary); margin-bottom: 10px;">å‚è€ƒå›¾ç‰‡é¢„è§ˆ</h3>
                    <div style="display: flex; gap: 20px; justify-content: center; align-items: center;">
                        <img id="source-image-preview"
                            style="max-height: 200px; max-width: 100%; border-radius: 8px; border: 2px solid var(--border);" />
                        <div id="image-stats" style="text-align: left; font-size: 14px; color: var(--text-muted);">
                            <div>é‡‡æ ·ç‚¹æ•°: <span id="sample-count-display">-</span></div>
                        </div>
                    </div>
                    <canvas id="sampling-canvas" style="display: none;"></canvas>
                </div>

                <div class="color-grid" id="color-grid">
                    <!-- é¢œè‰²å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </main>

        <aside class="sidebar">
            <div class="controls">
                <h2>âš™ï¸ å‚æ•°è®¾ç½®</h2>

                <div class="control-group">
                    <label>ä¼˜åŒ–æ¥æº:</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <label
                            style="font-weight: normal; display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="source-mode" value="GLOBAL" checked style="width: auto;"> å…¨é‡è‰²è°±
                        </label>
                        <label
                            style="font-weight: normal; display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="source-mode" value="IMAGE" style="width: auto;"> å‚è€ƒå›¾ç‰‡
                        </label>
                    </div>
                </div>

                <div class="control-group" id="image-upload-group" style="display: none;">
                    <label for="image-upload">ä¸Šä¼ å›¾ç‰‡:</label>
                    <input type="file" id="image-upload" accept="image/*">
                    <p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;">* å°†ä»å›¾ç‰‡ä¸­éšæœºé‡‡æ ·é¢œè‰²ä½œä¸ºä¼˜åŒ–ç›®æ ‡</p>
                </div>

                <div class="control-group">
                    <label for="k-input">é¢œæ–™é¢„ç®— (K):</label>
                    <input type="number" id="k-input" min="1" max="100" value="30">
                </div>

                <div class="control-group">
                    <label for="steps-input">æ¨¡æ‹Ÿé€€ç«æ­¥æ•°:</label>
                    <input type="number" id="steps-input" min="1000" max="200000" value="80000" step="1000">
                </div>

                <div class="control-group">
                    <label for="patience-input">æå‰ç»ˆæ­¢è€å¿ƒå€¼ (æ­¥æ•°):</label>
                    <input type="number" id="patience-input" min="100" max="50000" value="5000" step="100"
                        title="å¦‚æœåœ¨æ­¤æ­¥æ•°å†…æ²¡æœ‰æ‰¾åˆ°æ›´å¥½çš„è§£ï¼Œåˆ™æå‰åœæ­¢ä¼˜åŒ–">
                </div>

                <div class="control-group">
                    <label for="target-mode">ä¼˜åŒ–ç›®æ ‡:</label>
                    <select id="target-mode">
                        <option value="MAX">æœ€å¤§ Î”E (æœ€åæƒ…å†µæœ€ä¼˜)</option>
                        <option value="AVG">å¹³å‡ Î”E (æ•´ä½“å¹³å‡æœ€ä¼˜)</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="seed-input">éšæœºç§å­:</label>
                    <input type="number" id="seed-input" min="1" max="999999" value="42">
                </div>

                <div class="control-group">
                    <label for="code-type">è‰²å·ç³»ç»Ÿ:</label>
                    <select id="code-type">
                        <option value="MARD">MARD</option>
                        <option value="COCO">COCO</option>
                        <option value="æ¼«æ¼«">æ¼«æ¼«</option>
                        <option value="ç›¼ç›¼">ç›¼ç›¼</option>
                        <option value="å’ªå°çª">å’ªå°çª</option>
                    </select>
                </div>

                <div class="display-controls">
                    <div class="display-type">
                        <input type="checkbox" id="show-hex" checked>
                        <label for="show-hex">æ˜¾ç¤ºHEX</label>
                    </div>
                    <div class="display-type">
                        <input type="checkbox" id="show-names" checked>
                        <label for="show-names">æ˜¾ç¤ºåç§°</label>
                    </div>
                </div>

                <button id="start-btn">å¼€å§‹ä¼˜åŒ–</button>
            </div>

            <div class="progress-panel">
                <h2>ğŸ“ˆ ä¼˜åŒ–è¿›åº¦</h2>

                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-info">
                        <span>è¿›åº¦</span>
                        <span id="progress-text">0%</span>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="current-min">-</div>
                        <div class="stat-label">æœ€å° Î”E</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="current-max">-</div>
                        <div class="stat-label">æœ€å¤§ Î”E</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="current-avg">-</div>
                        <div class="stat-label">å¹³å‡ Î”E</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="best-error">-</div>
                        <div class="stat-label" id="best-error-label">æœ€ä½³æŒ‡æ ‡</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="temperature">-</div>
                        <div class="stat-label">å½“å‰æ¸©åº¦</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="step-count">0</div>
                        <div class="stat-label">å·²æ‰§è¡Œæ­¥æ•°</div>
                    </div>
                </div>

                <h3 style="margin: 20px 0 10px 0; color: var(--accent-primary);">ä¼˜åŒ–æ—¥å¿—</h3>
                <div class="log-box" id="log-box">
                    <div class="log-line">å‡†å¤‡å¼€å§‹ä¼˜åŒ–...</div>
                </div>
            </div>
        </aside>

        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p style="color: var(--text-secondary); margin-top: 20px;">æ­£åœ¨åŠ è½½é¢œè‰²æ•°æ®...</p>
        </div>

        <!-- Confirm Dialog -->
        <div id="export-dialog"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center;">
            <div
                style="background: var(--bg-secondary); padding: 25px; border-radius: 15px; width: 500px; max-width: 90%; border: 1px solid var(--border); box-shadow: 0 10px 25px rgba(0,0,0,0.5);">
                <h2
                    style="color: var(--accent-primary); margin-bottom: 20px; border-bottom: 2px solid var(--accent-primary); padding-bottom: 10px;">
                    å¯¼å‡ºç»“æœ</h2>

                <div style="margin-bottom: 15px;">
                    <label
                        style="color: var(--text-secondary); font-weight: bold; display: block; margin-bottom: 10px;">æ ¼å¼:</label>
                    <select id="export-format"
                        style="width: 100%; padding: 8px; border-radius: 4px; background: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border);">
                        <option value="JSON" selected>JSON (é…ç½®)</option>
                        <option value="HEX">HEXåˆ—è¡¨</option>
                        <option value="CODE">è‰²å·åˆ—è¡¨</option>
                    </select>
                </div>

                <textarea id="export-textarea"
                    style="width: 100%; height: 200px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); padding: 10px; font-family: 'Courier New', monospace; resize: vertical; margin-bottom: 15px;"
                    readonly></textarea>

                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button id="copy-btn" style="width: auto; background: var(--accent-secondary);">å¤åˆ¶</button>
                    <button id="close-dialog-btn"
                        style="width: auto; background: var(--bg-card); border-color: var(--text-muted);">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é¢œè‰²æ•°æ®
        const colorData = {};

        // ç®—æ³•å‚æ•°é…ç½®
        class OptimizationConfig {
            constructor() {
                this.K_REPRESENTATIVES = parseInt(document.getElementById('k-input').value) || 30;
                this.SA_STEPS = parseInt(document.getElementById('steps-input').value) || 80000;
                this.T0 = 20.0;
                this.ALPHA = 0.9995;
                this.RANDOM_SEED = parseInt(document.getElementById('seed-input').value) || 42;
                this.MANDATORY_MARDS = new Set(['H02', 'H07']);
                this.UPDATE_INTERVAL = 100; // 100æ¯«ç§’æ›´æ–°ä¸€æ¬¡UI
                this.TARGET_MODE = document.getElementById('target-mode').value;
                this.SOURCE_MODE = document.querySelector('input[name="source-mode"]:checked').value;
            }

            updateFromUI() {
                this.K_REPRESENTATIVES = parseInt(document.getElementById('k-input').value) || 30;
                this.SA_STEPS = parseInt(document.getElementById('steps-input').value) || 80000;
                this.PATIENCE = parseInt(document.getElementById('patience-input').value) || 5000;
                this.RANDOM_SEED = parseInt(document.getElementById('seed-input').value) || 42;
                this.TARGET_MODE = document.getElementById('target-mode').value;
                this.SOURCE_MODE = document.querySelector('input[name="source-mode"]:checked').value;
            }
        }

        class ImageProcessor {
            constructor() {
                this.canvas = document.getElementById('sampling-canvas');
                this.ctx = this.canvas.getContext('2d');
            }

            loadImage(file) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = reject;
                    img.src = URL.createObjectURL(file);
                });
            }

            sampleColors(img, sampleCount = 4000) {
                // Resize canvas to reasonable size for processing (max 1000px dimension) to save memory
                const maxDim = 1000;
                let width = img.width;
                let height = img.height;

                if (width > maxDim || height > maxDim) {
                    const ratio = Math.min(maxDim / width, maxDim / height);
                    width = Math.floor(width * ratio);
                    height = Math.floor(height * ratio);
                }

                this.canvas.width = width;
                this.canvas.height = height;
                this.ctx.drawImage(img, 0, 0, width, height);

                const imageData = this.ctx.getImageData(0, 0, width, height);
                const data = imageData.data;
                const pixelCount = width * height;

                const samples = [];
                const random = new RandomGenerator(42); // Consistent sampling for same image

                // Random sampling
                for (let i = 0; i < sampleCount; i++) {
                    const idx = Math.floor(random.random() * pixelCount) * 4;
                    // Ignore fully transparent pixels
                    if (data[idx + 3] < 128) {
                        i--;
                        continue;
                    }
                    samples.push([data[idx], data[idx + 1], data[idx + 2]]);
                }

                return samples;
            }
        }

        // çº¿æ€§åŒä½™éšæœºæ•°ç”Ÿæˆå™¨
        class RandomGenerator {
            constructor(seed) {
                this.seed = seed;
            }

            random() {
                this.seed = (this.seed * 9301 + 49297) % 233280;
                return this.seed / 233280;
            }

            randint(min, max) {
                return Math.floor(min + this.random() * (max - min));
            }
        }

        // ä¸»ä¼˜åŒ–ç±»
        class ColorOptimizer {
            constructor(config) {
                this.config = config;
                this.random = new RandomGenerator(config.RANDOM_SEED);
                this.colors = [];
                this.hexList = []; // Candidate HEXs
                this.codeMaps = {
                    MARD: new Map(),
                    COCO: new Map(),
                    'æ¼«æ¼«': new Map(),
                    'ç›¼ç›¼': new Map(),
                    'å’ªå°çª': new Map()
                };

                this.candidateLabColors = []; // Candidates (Beads) in Lab
                this.targetLabColors = [];    // Targets (Beads or Image) in Lab

                this.deltaE = null; // [targetIdx][candidateIdx]
                this.currentState = null;
                this.bestState = null;
                this.currentBestState = null;
                this.bestError = Infinity;
                this.currentBestError = Infinity;
                this.currentStep = 0;
                this.currentTemperature = config.T0;
                this.isRunning = false;
                this.lastYieldTime = 0;
                this.maxDist = 0;
                this.maxDist = 0;
                this.noImprovementSteps = 0;
                this.currentBestSignature = "";
            }

            // Get a unique signature for the current state (sorted list of indices)
            getStateSignature(state) {
                return Array.from(state).sort((a, b) => a - b).join(',');
            }

            // RGBè½¬Labè½¬æ¢ï¼ˆç®€åŒ–ç‰ˆï¼‰
            rgbToLab(rgb) {
                const [r, g, b] = rgb.map(x => {
                    x = x / 255;
                    return x > 0.04045 ? Math.pow((x + 0.055) / 1.055, 2.4) : x / 12.92;
                });

                let x = (r * 0.4124 + g * 0.3576 + b * 0.1805) / 0.95047;
                let y = (r * 0.2126 + g * 0.7152 + b * 0.0722) / 1.00000;
                let z = (r * 0.0193 + g * 0.1192 + b * 0.9505) / 1.08883;

                x = x > 0.008856 ? Math.pow(x, 1 / 3) : (7.787 * x) + 16 / 116;
                y = y > 0.008856 ? Math.pow(y, 1 / 3) : (7.787 * y) + 16 / 116;
                z = z > 0.008856 ? Math.pow(z, 1 / 3) : (7.787 * z) + 16 / 116;

                return [
                    (116 * y) - 16,
                    500 * (x - y),
                    200 * (y - z)
                ];
            }

            hexToRgb(hex) {
                const r = parseInt(hex.substr(1, 2), 16);
                const g = parseInt(hex.substr(3, 2), 16);
                const b = parseInt(hex.substr(5, 2), 16);
                return [r, g, b];
            }

            loadColors(data) {
                this.colors = [];
                this.hexList = [];

                for (const [hex, info] of Object.entries(data)) {
                    if (info.MARD && info.MARD[0] >= 'A' && info.MARD[0] <= 'H') {
                        this.colors.push({
                            hex: hex,
                            mard: info.MARD,
                            coco: info.COCO || '',
                            manman: info.æ¼«æ¼« || '',
                            panpan: info.ç›¼ç›¼ || '',
                            mixiaowo: info.å’ªå°çª || '',
                            name: info.name || ''
                        });
                        this.hexList.push(hex);

                        this.codeMaps.MARD.set(hex, info.MARD);
                        if (info.COCO) this.codeMaps.COCO.set(hex, info.COCO);
                        if (info.æ¼«æ¼«) this.codeMaps.æ¼«æ¼«.set(hex, info.æ¼«æ¼«);
                        if (info.ç›¼ç›¼) this.codeMaps.ç›¼ç›¼.set(hex, info.ç›¼ç›¼);
                        if (info.å’ªå°çª) this.codeMaps.å’ªå°çª.set(hex, info.å’ªå°çª);
                    }
                }

                this.candidateLabColors = this.hexList.map(hex => {
                    const rgb = this.hexToRgb(hex);
                    return this.rgbToLab(rgb);
                });
            }

            setTargetColors(labColors) {
                this.targetLabColors = labColors;
                this.calculateDistanceMatrix();
            }

            calculateDistanceMatrix() {
                const numTargets = this.targetLabColors.length;
                const numCandidates = this.candidateLabColors.length;

                // deltaE[i][j] = distance between Target[i] and Candidate[j]
                this.deltaE = new Array(numTargets);

                for (let i = 0; i < numTargets; i++) {
                    this.deltaE[i] = new Array(numCandidates);
                    for (let j = 0; j < numCandidates; j++) {
                        const diff = [
                            this.targetLabColors[i][0] - this.candidateLabColors[j][0],
                            this.targetLabColors[i][1] - this.candidateLabColors[j][1],
                            this.targetLabColors[i][2] - this.candidateLabColors[j][2]
                        ];
                        this.deltaE[i][j] = Math.sqrt(
                            diff[0] * diff[0] + diff[1] * diff[1] + diff[2] * diff[2]
                        );
                    }
                }

                this.maxDist = Math.max(...this.deltaE.map(row => Math.max(...row)));
            }
            calculateStats(state) {
                const stateArray = Array.from(state);
                let maxDist = 0;
                let minDistTotal = Infinity; // å…¨å±€æœ€å°
                let sumDist = 0;

                const numTargets = this.deltaE.length;

                for (let i = 0; i < numTargets; i++) {
                    let minDist = Infinity; // å½“å‰ç‚¹åˆ°æœ€è¿‘é‡‡æ ·ç‚¹çš„è·ç¦»
                    for (const j of stateArray) {
                        // j is index of candidate (bead)
                        if (this.deltaE[i][j] < minDist) {
                            minDist = this.deltaE[i][j];
                        }
                    }
                    if (minDist > maxDist) maxDist = minDist;
                    if (minDist < minDistTotal) minDistTotal = minDist;
                    sumDist += minDist;
                }

                return {
                    max: maxDist,
                    min: minDistTotal,
                    avg: sumDist / numTargets
                };
            }

            getObjective(stats) {
                return this.config.TARGET_MODE === 'MAX' ? stats.max : stats.avg;
            }


            getFPSInitialization(k, fixedIndices = new Set()) {
                const numCandidates = this.candidateLabColors.length;
                const numTargets = this.targetLabColors.length;
                const selected = new Set(fixedIndices);
                const variableSelected = new Set();

                // FPS needs to be adapted for Asymmetric Matrix (Targets != Candidates)
                // Standard FPS selects points from S to cover S.
                // Here we select points from CANDIDATES to cover TARGETS.
                // Simplified Grease: Just pick random candidates if Asymmetric?
                // Or: greedily pick candidate that reduces max error the most (expensive).
                // Let's stick to random init for Image mode for now to save complexity, 
                // or use a simplified greedy approach.
                // If Global Mode (Targets == Candidates), use original FPS logic.

                if (this.config.SOURCE_MODE === 'GLOBAL') {
                    // Initial implementation of FPS for Global Mode
                    const minDists = new Array(numCandidates).fill(Infinity);

                    if (fixedIndices.size === 0) {
                        const first = Math.floor(this.random.random() * numCandidates);
                        selected.add(first);
                        variableSelected.add(first);
                        for (let i = 0; i < numCandidates; i++) {
                            minDists[i] = this.deltaE[i][first]; // deltaE is Symmetric here
                        }
                    } else {
                        // ... logic for fixed indices ...
                        for (let i = 0; i < numCandidates; i++) {
                            let minDist = Infinity;
                            for (const fixedIdx of fixedIndices) {
                                if (this.deltaE[i][fixedIdx] < minDist) minDist = this.deltaE[i][fixedIdx];
                            }
                            minDists[i] = minDist;
                        }
                    }

                    for (let count = 0; count < k; count++) {
                        let farthestIdx = 0;
                        let maxDist = 0;

                        for (let i = 0; i < numCandidates; i++) {
                            if (!selected.has(i) && minDists[i] > maxDist) {
                                maxDist = minDists[i];
                                farthestIdx = i;
                            }
                        }

                        if (maxDist === 0) break;

                        selected.add(farthestIdx);
                        variableSelected.add(farthestIdx);

                        for (let i = 0; i < numCandidates; i++) {
                            if (this.deltaE[i][farthestIdx] < minDists[i]) {
                                minDists[i] = this.deltaE[i][farthestIdx];
                            }
                        }
                    }
                    return variableSelected;
                } else {
                    // Random Init for Image Mode (simplest effective strategy)
                    while (variableSelected.size < k) {
                        const idx = Math.floor(this.random.random() * numCandidates);
                        if (!selected.has(idx)) {
                            variableSelected.add(idx);
                            selected.add(idx);
                        }
                    }
                    return variableSelected;
                }
            }

            async * simulatedAnnealing() {
                this.config.updateFromUI();
                this.random = new RandomGenerator(this.config.RANDOM_SEED);
                this.isRunning = true;
                this.currentStep = 0;
                this.currentTemperature = this.config.T0;
                this.lastYieldTime = performance.now();
                this.noImprovementSteps = 0;
                this.currentBestSignature = "";

                const fixedIndices = new Set();
                for (let i = 0; i < this.hexList.length; i++) {
                    const mard = this.codeMaps.MARD.get(this.hexList[i]);
                    if (this.config.MANDATORY_MARDS.has(mard)) {
                        fixedIndices.add(i);
                    }
                }

                this.currentState = this.getFPSInitialization(
                    this.config.K_REPRESENTATIVES,
                    fixedIndices
                );
                this.bestState = new Set(this.currentState);
                this.currentBestState = new Set(this.currentState);

                const initialStats = this.calculateStats(new Set([...this.currentState, ...fixedIndices]));
                this.bestError = this.getObjective(initialStats);
                this.currentBestError = this.bestError;

                const radiusDecay = Math.pow(1.0 / (this.maxDist + 1e-6), 1.0 / this.config.SA_STEPS);

                yield {
                    type: 'initialized',
                    bestError: this.bestError,
                    stats: initialStats,
                    currentState: this.currentState,
                    fixedIndices: fixedIndices
                };

                for (let step = 0; step < this.config.SA_STEPS && this.isRunning; step++) {
                    this.currentStep = step;

                    // Early Exit Check
                    if (this.noImprovementSteps > this.config.PATIENCE) {
                        yield {
                            type: 'stopped',
                            reason: 'early_exit',
                            step: step,
                            patience: this.config.PATIENCE,
                            bestError: this.bestError
                        };
                        break;
                    }

                    const newState = new Set(this.currentState);
                    const currentRadius = this.maxDist * Math.pow(radiusDecay, step);

                    const stateArray = Array.from(newState);
                    const outIdx = Math.floor(this.random.random() * stateArray.length);
                    const out = stateArray[outIdx];
                    newState.delete(out);

                    let candidates = [];
                    // Simple version: Pick random replacement
                    // Optimized version: Only pick candidates that are "close" to the area uncovered by removing 'out'.
                    // Given Asymmetric matrix, "closeness" is hard to define without precomputing candidate-candidate distances.
                    // Let's stick to global random replacement or precompute candidate stats.
                    // For simplified impl: Random replacement.
                    // BUT the original logic used deltaE[out][i] to find nearby candidates (local search).
                    // If deltaE is now Target x Candidate (N x M), we can't look up Candidate x Candidate distance easily 
                    // unless we keep the symmetric matrix too, or just calc on fly.

                    // Fallback: simple random swap is robust enough for SA. 
                    // If Global Mode, deltaE is symmetric, so we can use it.

                    if (this.config.SOURCE_MODE === 'GLOBAL') {
                        // Original Logic using deltaE
                        for (let i = 0; i < this.candidateLabColors.length; i++) {
                            if (this.deltaE[out][i] < currentRadius &&
                                !newState.has(i) &&
                                !fixedIndices.has(i)) {
                                candidates.push(i);
                            }
                        }
                    } else {
                        // Image Mode: Random candidate
                        // Or we could compute distance between 'out' bead and 'i' bead on fly.
                        const outRgb = this.hexToRgb(this.hexList[out]);
                        const outLab = this.rgbToLab(outRgb);
                        // We can optimize this by caching candidate-candidate distances, but memory...
                        // Let's just do fully random for now, radius decay concept is less critical if acceptance probability handles it.
                        // Actually, local search is capable of finetuning.
                        // Let's pick a random candidate.
                        const randCand = Math.floor(this.random.random() * this.candidateLabColors.length);
                        if (!newState.has(randCand) && !fixedIndices.has(randCand)) {
                            candidates.push(randCand);
                        }
                    }

                    let inn = out;
                    if (candidates.length > 0) {
                        inn = candidates[Math.floor(this.random.random() * candidates.length)];
                    }
                    newState.add(inn);

                    const oldStateWithFixed = new Set([...this.currentState, ...fixedIndices]);
                    const newStateWithFixed = new Set([...newState, ...fixedIndices]);



                    const oldStats = this.calculateStats(oldStateWithFixed);
                    const newStats = this.calculateStats(newStateWithFixed);

                    const oldError = this.getObjective(oldStats);
                    const newError = this.getObjective(newStats);

                    if (newError < oldError ||
                        this.random.random() < Math.exp((oldError - newError) / this.currentTemperature)) {
                        this.currentState = newState;

                        if (newError < this.bestError) {
                            this.bestState = new Set(this.currentState);
                            this.bestError = newError;
                        }

                        this.currentBestState = new Set(this.currentState);
                        this.currentBestError = newError;

                        // Check signature change for patience
                        const newSignature = this.getStateSignature(this.currentState);
                        if (newSignature !== this.currentBestSignature) {
                            this.noImprovementSteps = 0;
                            this.currentBestSignature = newSignature;
                        } else {
                            this.noImprovementSteps++;
                        }
                    } else {
                        // Even if we didn't accept, we technically didn't improve state.
                        // But usually patience tracks "time since last global improvement".
                        // Standard SA patience often counts total steps since best found.
                        // My previous implementation counted steps in specific branch.
                        // Let's stick to "steps since best signature changed".
                        this.noImprovementSteps++;
                    }

                    this.currentTemperature *= this.config.ALPHA;

                    const currentTime = performance.now();
                    if (currentTime - this.lastYieldTime >= this.config.UPDATE_INTERVAL) {
                        // Recalculate stats for the best state to show in UI
                        const bestStats = this.calculateStats(new Set([...this.currentBestState, ...fixedIndices]));

                        yield {
                            type: 'progress',
                            step: step + 1,
                            totalSteps: this.config.SA_STEPS,
                            bestError: this.bestError,
                            currentError: this.currentBestError,
                            stats: bestStats,
                            temperature: this.currentTemperature,
                            progress: ((step + 1) / this.config.SA_STEPS) * 100,
                            currentState: this.currentBestState,
                            fixedIndices: fixedIndices
                        };
                        this.lastYieldTime = currentTime;
                    }
                }

                yield {
                    type: 'completed',
                    bestError: this.bestError,
                    bestState: this.bestState,
                    fixedIndices: fixedIndices
                };

                this.isRunning = false;
            }

            getColorCodes(codeType, hex) {
                return this.codeMaps[codeType]?.get(hex) || '';
            }

            stop() {
                this.isRunning = false;
            }
        }

        // UIæ§åˆ¶å™¨
        class UIController {
            constructor() {
                this.optimizer = null;
                this.imageProcessor = new ImageProcessor();
                this.currentAnimation = null;
                this.updateTimeout = null;
                this.uploadedImage = null; // Store the loaded image object
            }

            init() {
                this.bindEvents();
                this.loadColorData();
            }

            async loadColorData() {
                const loading = document.getElementById('loading');
                const startBtn = document.getElementById('start-btn');
                const logBox = document.getElementById('log-box');

                loading.style.display = 'flex';
                loading.style.flexDirection = 'column';
                loading.style.justifyContent = 'center';
                loading.style.alignItems = 'center';
                startBtn.disabled = true;

                try {
                    const data = { "#FAF4C8": { "MARD": "A01", "COCO": "E02", "æ¼«æ¼«": "E2", "ç›¼ç›¼": "65", "å’ªå°çª": "77" }, "#FFFFD5": { "MARD": "A02", "COCO": "E01", "æ¼«æ¼«": "B1", "ç›¼ç›¼": "2", "å’ªå°çª": "2" }, "#FEFF8B": { "MARD": "A03", "COCO": "E05", "æ¼«æ¼«": "B2", "ç›¼ç›¼": "28", "å’ªå°çª": "28" }, "#FBED56": { "MARD": "A04", "COCO": "E07", "æ¼«æ¼«": "B3", "ç›¼ç›¼": "3", "å’ªå°çª": "3" }, "#F4D738": { "MARD": "A05", "COCO": "D03", "æ¼«æ¼«": "B4", "ç›¼ç›¼": "74", "å’ªå°çª": "79" }, "#FEAC4C": { "MARD": "A06", "COCO": "D05", "æ¼«æ¼«": "B5", "ç›¼ç›¼": "29", "å’ªå°çª": "29" }, "#FE8B4C": { "MARD": "A07", "COCO": "D08", "æ¼«æ¼«": "B6", "ç›¼ç›¼": "4", "å’ªå°çª": "4" }, "#FFDA45": { "MARD": "A08", "COCO": "E08", "æ¼«æ¼«": "B10", "ç›¼ç›¼": "88", "å’ªå°çª": "98" }, "#FF995B": { "MARD": "A09", "COCO": "D06", "æ¼«æ¼«": "B11", "ç›¼ç›¼": "90", "å’ªå°çª": "97" }, "#F77C31": { "MARD": "A10", "COCO": "D07", "æ¼«æ¼«": "B12", "ç›¼ç›¼": "89", "å’ªå°çª": "96" }, "#FFDD99": { "MARD": "A11", "COCO": "D01", "æ¼«æ¼«": "E11", "ç›¼ç›¼": "100", "å’ªå°çª": "109" }, "#FE9F72": { "MARD": "A12", "COCO": "K09", "æ¼«æ¼«": "A18", "ç›¼ç›¼": "99", "å’ªå°çª": "110" }, "#FFC365": { "MARD": "A13", "COCO": "D04", "æ¼«æ¼«": "B13", "ç›¼ç›¼": "131", "å’ªå°çª": "116" }, "#FD543D": { "MARD": "A14", "COCO": "C05", "æ¼«æ¼«": "B14", "ç›¼ç›¼": "138", "å’ªå°çª": "135" }, "#FFF365": { "MARD": "A15", "COCO": "E04", "æ¼«æ¼«": "B15", "ç›¼ç›¼": "150", "å’ªå°çª": "150" }, "#FFFF9F": { "MARD": "A16", "COCO": "E03", "æ¼«æ¼«": "IC04", "ç›¼ç›¼": "216", "å’ªå°çª": "216" }, "#FFE36E": { "MARD": "A17", "COCO": "E06", "æ¼«æ¼«": "IC9", "ç›¼ç›¼": "213", "å’ªå°çª": "213" }, "#FEBE7D": { "MARD": "A18", "COCO": "D02", "æ¼«æ¼«": "IC14", "ç›¼ç›¼": "223", "å’ªå°çª": "208" }, "#FD7C72": { "MARD": "A19", "COCO": "K10", "æ¼«æ¼«": "IC15", "ç›¼ç›¼": "218", "å’ªå°çª": "218" }, "#FFD568": { "MARD": "A20", "COCO": "E09", "æ¼«æ¼«": "Q6", "ç›¼ç›¼": "242", "å’ªå°çª": "242" }, "#FFE395": { "MARD": "A21", "COCO": "E10", "æ¼«æ¼«": "R07", "ç›¼ç›¼": "276", "å’ªå°çª": "261" }, "#F4F57D": { "MARD": "A22", "COCO": "E11", "æ¼«æ¼«": "R06", "ç›¼ç›¼": "270", "å’ªå°çª": "255" }, "#E6C9B7": { "MARD": "A23", "COCO": "E12", "æ¼«æ¼«": "R08", "ç›¼ç›¼": "274", "å’ªå°çª": "259" }, "#F7F8A2": { "MARD": "A24", "COCO": "E13", "æ¼«æ¼«": "G3", "ç›¼ç›¼": "288", "å’ªå°çª": "273" }, "#FFD67D": { "MARD": "A25", "COCO": "E14", "æ¼«æ¼«": "G4", "ç›¼ç›¼": "289", "å’ªå°çª": "274" }, "#FFC830": { "MARD": "A26", "COCO": "E15", "æ¼«æ¼«": "G5", "ç›¼ç›¼": "290", "å’ªå°çª": "275" }, "#E6EE31": { "MARD": "B01", "COCO": "F05", "æ¼«æ¼«": "C1", "ç›¼ç›¼": "48", "å’ªå°çª": "48" }, "#63F347": { "MARD": "B02", "COCO": "F08", "æ¼«æ¼«": "C2", "ç›¼ç›¼": "33", "å’ªå°çª": "33" }, "#9EF780": { "MARD": "B03", "COCO": "F04", "æ¼«æ¼«": "C7", "ç›¼ç›¼": "26", "å’ªå°çª": "26" }, "#5DE035": { "MARD": "B04", "COCO": "F09", "æ¼«æ¼«": "C3", "ç›¼ç›¼": "66", "å’ªå°çª": "78" }, "#35E352": { "MARD": "B05", "COCO": "F10", "æ¼«æ¼«": "C4", "ç›¼ç›¼": "39", "å’ªå°çª": "39" }, "#65E2A6": { "MARD": "B06", "COCO": "G04", "æ¼«æ¼«": "C9", "ç›¼ç›¼": "11", "å’ªå°çª": "11" }, "#3DAF80": { "MARD": "B07", "COCO": "G05", "æ¼«æ¼«": "C10", "ç›¼ç›¼": "44", "å’ªå°çª": "44" }, "#1C9C4F": { "MARD": "B08", "COCO": "F11", "æ¼«æ¼«": "C5", "ç›¼ç›¼": "10", "å’ªå°çª": "10" }, "#27523A": { "MARD": "B09", "COCO": "F16", "æ¼«æ¼«": "C6", "ç›¼ç›¼": "79", "å’ªå°çª": "84" }, "#95D3C2": { "MARD": "B10", "COCO": "G03", "æ¼«æ¼«": "C11", "ç›¼ç›¼": "96", "å’ªå°çª": "100" }, "#5D722A": { "MARD": "B11", "COCO": "F14", "æ¼«æ¼«": "C12", "ç›¼ç›¼": "97", "å’ªå°çª": "99" }, "#166F41": { "MARD": "B12", "COCO": "F12", "æ¼«æ¼«": "C13", "ç›¼ç›¼": "106", "å’ªå°çª": "111" }, "#CAEB7B": { "MARD": "B13", "COCO": "F02", "æ¼«æ¼«": "C14", "ç›¼ç›¼": "128", "å’ªå°çª": "119" }, "#ADE946": { "MARD": "B14", "COCO": "F06", "æ¼«æ¼«": "C15", "ç›¼ç›¼": "129", "å’ªå°çª": "117" }, "#2E5132": { "MARD": "B15", "COCO": "F15", "æ¼«æ¼«": "C16", "ç›¼ç›¼": "130", "å’ªå°çª": "122" }, "#C5ED9C": { "MARD": "B16", "COCO": "F03", "æ¼«æ¼«": "C17", "ç›¼ç›¼": "141", "å’ªå°çª": "133" }, "#9BB13A": { "MARD": "B17", "COCO": "F13", "æ¼«æ¼«": "C18", "ç›¼ç›¼": "142", "å’ªå°çª": "141" }, "#E6EE49": { "MARD": "B18", "COCO": "F07", "æ¼«æ¼«": "C19", "ç›¼ç›¼": "147", "å’ªå°çª": "147" }, "#24B88C": { "MARD": "B19", "COCO": "G06", "æ¼«æ¼«": "DH15", "ç›¼ç›¼": "191", "å’ªå°çª": "174" }, "#C2F0CC": { "MARD": "B20", "COCO": "G02", "æ¼«æ¼«": "DH10", "ç›¼ç›¼": "192", "å’ªå°çª": "175" }, "#156A6B": { "MARD": "B21", "COCO": "G07", "æ¼«æ¼«": "DH2", "ç›¼ç›¼": "207", "å’ªå°çª": "194" }, "#0B3C43": { "MARD": "B22", "COCO": "G08", "æ¼«æ¼«": "DH7", "ç›¼ç›¼": "206", "å’ªå°çª": "193" }, "#303A21": { "MARD": "B23", "COCO": "F17", "æ¼«æ¼«": "DH12", "ç›¼ç›¼": "205", "å’ªå°çª": "192" }, "#EEFCA5": { "MARD": "B24", "COCO": "F01", "æ¼«æ¼«": "IC5", "ç›¼ç›¼": "222", "å’ªå°çª": "207" }, "#4E846D": { "MARD": "B25", "COCO": "F18", "æ¼«æ¼«": "Q13", "ç›¼ç›¼": "240", "å’ªå°çª": "240" }, "#8D7A35": { "MARD": "B26", "COCO": "F19", "æ¼«æ¼«": "Q7", "ç›¼ç›¼": "248", "å’ªå°çª": "248" }, "#CCE1AF": { "MARD": "B27", "COCO": "F20", "æ¼«æ¼«": "R10", "ç›¼ç›¼": "262", "å’ªå°çª": "262" }, "#9EE5B9": { "MARD": "B28", "COCO": "F21", "æ¼«æ¼«": "R11", "ç›¼ç›¼": "269", "å’ªå°çª": "254" }, "#C5E254": { "MARD": "B29", "COCO": "F22", "æ¼«æ¼«": "R09", "ç›¼ç›¼": "268", "å’ªå°çª": "253" }, "#E2FCB1": { "MARD": "B30", "COCO": "F23", "æ¼«æ¼«": "G6", "ç›¼ç›¼": "285", "å’ªå°çª": "270" }, "#B0E792": { "MARD": "B31", "COCO": "F24", "æ¼«æ¼«": "G7", "ç›¼ç›¼": "286", "å’ªå°çª": "271" }, "#9CAB5A": { "MARD": "B32", "COCO": "F25", "æ¼«æ¼«": "G12", "ç›¼ç›¼": "287", "å’ªå°çª": "272" }, "#E8FFE7": { "MARD": "C01", "COCO": "G01", "æ¼«æ¼«": "C8", "ç›¼ç›¼": "64", "å’ªå°çª": "76" }, "#A9F9FC": { "MARD": "C02", "COCO": "H03", "æ¼«æ¼«": "D1", "ç›¼ç›¼": "30", "å’ªå°çª": "30" }, "#A0E2FB": { "MARD": "C03", "COCO": "H04", "æ¼«æ¼«": "D2", "ç›¼ç›¼": "63", "å’ªå°çª": "75" }, "#41CCFF": { "MARD": "C04", "COCO": "H05", "æ¼«æ¼«": "D3", "ç›¼ç›¼": "77", "å’ªå°çª": "82" }, "#01ACEB": { "MARD": "C05", "COCO": "H07", "æ¼«æ¼«": "D7", "ç›¼ç›¼": "34", "å’ªå°çª": "34" }, "#50AAF0": { "MARD": "C06", "COCO": "H08", "æ¼«æ¼«": "D4", "ç›¼ç›¼": "25", "å’ªå°çª": "25" }, "#3677D2": { "MARD": "C07", "COCO": "H13", "æ¼«æ¼«": "D8", "ç›¼ç›¼": "9", "å’ªå°çª": "9" }, "#0F54C0": { "MARD": "C08", "COCO": "H14", "æ¼«æ¼«": "D9", "ç›¼ç›¼": "52", "å’ªå°çª": "71" }, "#324BCA": { "MARD": "C09", "COCO": "H16", "æ¼«æ¼«": "N5", "ç›¼ç›¼": "42", "å’ªå°çª": "42" }, "#3EBCE2": { "MARD": "C10", "COCO": "H09", "æ¼«æ¼«": "D25", "ç›¼ç›¼": "121", "å’ªå°çª": "130" }, "#28DDDE": { "MARD": "C11", "COCO": "H10", "æ¼«æ¼«": "D28", "ç›¼ç›¼": "122", "å’ªå°çª": "113" }, "#1C334D": { "MARD": "C12", "COCO": "H23", "æ¼«æ¼«": "D26", "ç›¼ç›¼": "120", "å’ªå°çª": "120" }, "#CDE8FF": { "MARD": "C13", "COCO": "H01", "æ¼«æ¼«": "D30", "ç›¼ç›¼": "140", "å’ªå°çª": "142" }, "#D5FDFF": { "MARD": "C14", "COCO": "H02", "æ¼«æ¼«": "D29", "ç›¼ç›¼": "139", "å’ªå°çª": "136" }, "#22C4C6": { "MARD": "C15", "COCO": "H11", "æ¼«æ¼«": "D31", "ç›¼ç›¼": "143", "å’ªå°çª": "132" }, "#1557A8": { "MARD": "C16", "COCO": "H18", "æ¼«æ¼«": "D32", "ç›¼ç›¼": "149", "å’ªå°çª": "149" }, "#04D1F6": { "MARD": "C17", "COCO": "H19", "æ¼«æ¼«": "D36", "ç›¼ç›¼": "163", "å’ªå°çª": "156" }, "#1D3344": { "MARD": "C18", "COCO": "H24", "æ¼«æ¼«": "DH6", "ç›¼ç›¼": "196", "å’ªå°çª": "196" }, "#1887A2": { "MARD": "C19", "COCO": "H12", "æ¼«æ¼«": "DH9", "ç›¼ç›¼": "202", "å’ªå°çª": "202" }, "#176DAF": { "MARD": "C20", "COCO": "H17", "æ¼«æ¼«": "DH14", "ç›¼ç›¼": "197", "å’ªå°çª": "197" }, "#BEDDFF": { "MARD": "C21", "COCO": "H06", "æ¼«æ¼«": "IC3", "ç›¼ç›¼": "212", "å’ªå°çª": "212" }, "#67B4BE": { "MARD": "C22", "COCO": "H25", "æ¼«æ¼«": "Q11", "ç›¼ç›¼": "239", "å’ªå°çª": "239" }, "#C8E2FF": { "MARD": "C23", "COCO": "H26", "æ¼«æ¼«": "R13", "ç›¼ç›¼": "263", "å’ªå°çª": "263" }, "#7CC4FF": { "MARD": "C24", "COCO": "H27", "æ¼«æ¼«": "R14", "ç›¼ç›¼": "267", "å’ªå°çª": "252" }, "#A9E5E5": { "MARD": "C25", "COCO": "H28", "æ¼«æ¼«": "R12", "ç›¼ç›¼": "271", "å’ªå°çª": "256" }, "#3CAED8": { "MARD": "C26", "COCO": "H29", "æ¼«æ¼«": "R15", "ç›¼ç›¼": "265", "å’ªå°çª": "250" }, "#D3DFFA": { "MARD": "C27", "COCO": "H30", "æ¼«æ¼«": "G13", "ç›¼ç›¼": "279", "å’ªå°çª": "264" }, "#BBCFED": { "MARD": "C28", "COCO": "H31", "æ¼«æ¼«": "G14", "ç›¼ç›¼": "280", "å’ªå°çª": "265" }, "#34488E": { "MARD": "C29", "COCO": "H32", "æ¼«æ¼«": "G15", "ç›¼ç›¼": "281", "å’ªå°çª": "266" }, "#AEB4F2": { "MARD": "D01", "COCO": "J07", "æ¼«æ¼«": "D5", "ç›¼ç›¼": "46", "å’ªå°çª": "46" }, "#858EDD": { "MARD": "D02", "COCO": "J08", "æ¼«æ¼«": "D6", "ç›¼ç›¼": "36", "å’ªå°çª": "36" }, "#2F54AF": { "MARD": "D03", "COCO": "H15", "æ¼«æ¼«": "D10", "ç›¼ç›¼": "8", "å’ªå°çª": "8" }, "#182A84": { "MARD": "D04", "COCO": "H20", "æ¼«æ¼«": "D11", "ç›¼ç›¼": "75", "å’ªå°çª": "80" }, "#B843C5": { "MARD": "D05", "COCO": "J12", "æ¼«æ¼«": "D13", "ç›¼ç›¼": "32", "å’ªå°çª": "32" }, "#AC7BDE": { "MARD": "D06", "COCO": "J11", "æ¼«æ¼«": "D14", "ç›¼ç›¼": "27", "å’ªå°çª": "27" }, "#8854B3": { "MARD": "D07", "COCO": "J15", "æ¼«æ¼«": "D12", "ç›¼ç›¼": "7", "å’ªå°çª": "7" }, "#E2D3FF": { "MARD": "D08", "COCO": "J03", "æ¼«æ¼«": "D16", "ç›¼ç›¼": "94", "å’ªå°çª": "89" }, "#D5B9F8": { "MARD": "D09", "COCO": "J04", "æ¼«æ¼«": "D17", "ç›¼ç›¼": "93", "å’ªå°çª": "90" }, "#361851": { "MARD": "D10", "COCO": "J19", "æ¼«æ¼«": "D15", "ç›¼ç›¼": "92", "å’ªå°çª": "91" }, "#B9BAE1": { "MARD": "D11", "COCO": "J06", "æ¼«æ¼«": "D19", "ç›¼ç›¼": "105", "å’ªå°çª": "104" }, "#DE9AD4": { "MARD": "D12", "COCO": "J10", "æ¼«æ¼«": "D20", "ç›¼ç›¼": "104", "å’ªå°çª": "105" }, "#B90095": { "MARD": "D13", "COCO": "J14", "æ¼«æ¼«": "D21", "ç›¼ç›¼": "103", "å’ªå°çª": "106" }, "#8B279B": { "MARD": "D14", "COCO": "J16", "æ¼«æ¼«": "D22", "ç›¼ç›¼": "102", "å’ªå°çª": "107" }, "#2F1F90": { "MARD": "D15", "COCO": "H22", "æ¼«æ¼«": "D18", "ç›¼ç›¼": "101", "å’ªå°çª": "108" }, "#E3E1EE": { "MARD": "D16", "COCO": "J01", "æ¼«æ¼«": "D23", "ç›¼ç›¼": "118", "å’ªå°çª": "126" }, "#C4D4F6": { "MARD": "D17", "COCO": "J05", "æ¼«æ¼«": "D24", "ç›¼ç›¼": "119", "å’ªå°çª": "128" }, "#A45EC7": { "MARD": "D18", "COCO": "J13", "æ¼«æ¼«": "D27", "ç›¼ç›¼": "124", "å’ªå°çª": "125" }, "#D8C3D7": { "MARD": "D19", "COCO": "J09", "æ¼«æ¼«": "D33", "ç›¼ç›¼": "153", "å’ªå°çª": "153" }, "#9C32B2": { "MARD": "D20", "COCO": "J17", "æ¼«æ¼«": "D34", "ç›¼ç›¼": "161", "å’ªå°çª": "155" }, "#9A009B": { "MARD": "D21", "COCO": "J18", "æ¼«æ¼«": "D35", "ç›¼ç›¼": "162", "å’ªå°çª": "158" }, "#333A95": { "MARD": "D22", "COCO": "H21", "æ¼«æ¼«": "DH1", "ç›¼ç›¼": "198", "å’ªå°çª": "198" }, "#EBDAFC": { "MARD": "D23", "COCO": "J02", "æ¼«æ¼«": "IC8", "ç›¼ç›¼": "217", "å’ªå°çª": "217" }, "#7786E5": { "MARD": "D24", "COCO": "J20", "æ¼«æ¼«": "Q14", "ç›¼ç›¼": "244", "å’ªå°çª": "244" }, "#494FC7": { "MARD": "D25", "COCO": "J21", "æ¼«æ¼«": "Q15", "ç›¼ç›¼": "249", "å’ªå°çª": "234" }, "#DFC2F8": { "MARD": "D26", "COCO": "J22", "æ¼«æ¼«": "R01", "ç›¼ç›¼": "273", "å’ªå°çª": "258" }, "#FDD3CC": { "MARD": "E01", "COCO": "K03", "æ¼«æ¼«": "E1", "ç›¼ç›¼": "18", "å’ªå°çª": "18" }, "#FEC0DF": { "MARD": "E02", "COCO": "K15", "æ¼«æ¼«": "A7", "ç›¼ç›¼": "38", "å’ªå°çª": "38" }, "#FFB7E7": { "MARD": "E03", "COCO": "K17", "æ¼«æ¼«": "A8", "ç›¼ç›¼": "62", "å’ªå°çª": "74" }, "#E8649E": { "MARD": "E04", "COCO": "K21", "æ¼«æ¼«": "A9", "ç›¼ç›¼": "6", "å’ªå°çª": "6" }, "#F551A2": { "MARD": "E05", "COCO": "K19", "æ¼«æ¼«": "A10", "ç›¼ç›¼": "40", "å’ªå°çª": "40" }, "#F13D74": { "MARD": "E06", "COCO": "K22", "æ¼«æ¼«": "A11", "ç›¼ç›¼": "20", "å’ªå°çª": "20" }, "#C63478": { "MARD": "E07", "COCO": "K25", "æ¼«æ¼«": "A12", "ç›¼ç›¼": "41", "å’ªå°çª": "41" }, "#FFDBE9": { "MARD": "E08", "COCO": "K12", "æ¼«æ¼«": "A13", "ç›¼ç›¼": "84", "å’ªå°çª": "103" }, "#E970CC": { "MARD": "E09", "COCO": "K18", "æ¼«æ¼«": "A14", "ç›¼ç›¼": "98", "å’ªå°çª": "95" }, "#D33793": { "MARD": "E10", "COCO": "K23", "æ¼«æ¼«": "A16", "ç›¼ç›¼": "83", "å’ªå°çª": "94" }, "#FCDDD2": { "MARD": "E11", "COCO": "K02", "æ¼«æ¼«": "A19", "ç›¼ç›¼": "125", "å’ªå°çª": "131" }, "#F78FC3": { "MARD": "E12", "COCO": "K16", "æ¼«æ¼«": "A20", "ç›¼ç›¼": "126", "å’ªå°çª": "112" }, "#B5006D": { "MARD": "E13", "COCO": "K24", "æ¼«æ¼«": "A21", "ç›¼ç›¼": "127", "å’ªå°çª": "124" }, "#FFD1BA": { "MARD": "E14", "COCO": "K05", "æ¼«æ¼«": "E21", "ç›¼ç›¼": "137", "å’ªå°çª": "140" }, "#F8C7C9": { "MARD": "E15", "COCO": "K04", "æ¼«æ¼«": "A23", "ç›¼ç›¼": "135", "å’ªå°çª": "139" }, "#FFF3EB": { "MARD": "E16", "COCO": "K01", "æ¼«æ¼«": "IC2", "ç›¼ç›¼": "221", "å’ªå°çª": "206" }, "#FFE2EA": { "MARD": "E17", "COCO": "K11", "æ¼«æ¼«": "IC7", "ç›¼ç›¼": "220", "å’ªå°çª": "205" }, "#FFC7DB": { "MARD": "E18", "COCO": "K13", "æ¼«æ¼«": "IC13", "ç›¼ç›¼": "210", "å’ªå°çª": "210" }, "#FEBAD5": { "MARD": "E19", "COCO": "K14", "æ¼«æ¼«": "IC12", "ç›¼ç›¼": "215", "å’ªå°çª": "215" }, "#D8C7D1": { "MARD": "E20", "COCO": "K26", "æ¼«æ¼«": "Q1", "ç›¼ç›¼": "241", "å’ªå°çª": "241" }, "#BD9DA1": { "MARD": "E21", "COCO": "K27", "æ¼«æ¼«": "Q2", "ç›¼ç›¼": "253", "å’ªå°çª": "238" }, "#B785A1": { "MARD": "E22", "COCO": "K28", "æ¼«æ¼«": "Q4", "ç›¼ç›¼": "252", "å’ªå°çª": "237" }, "#937A8D": { "MARD": "E23", "COCO": "K29", "æ¼«æ¼«": "Q3", "ç›¼ç›¼": "250", "å’ªå°çª": "235" }, "#E1BCE8": { "MARD": "E24", "COCO": "K30", "æ¼«æ¼«": "G8", "ç›¼ç›¼": "282", "å’ªå°çª": "267" }, "#FD957B": { "MARD": "F01", "COCO": "K08", "æ¼«æ¼«": "A1", "ç›¼ç›¼": "35", "å’ªå°çª": "35" }, "#FC3D46": { "MARD": "F02", "COCO": "C02", "æ¼«æ¼«": "A2", "ç›¼ç›¼": "31", "å’ªå°çª": "31" }, "#F74941": { "MARD": "F03", "COCO": "C03", "æ¼«æ¼«": "A3", "ç›¼ç›¼": "53", "å’ªå°çª": "72" }, "#FC283C": { "MARD": "F04", "COCO": "C06", "æ¼«æ¼«": "A4", "ç›¼ç›¼": "54", "å’ªå°çª": "73" }, "#E7002F": { "MARD": "F05", "COCO": "C07", "æ¼«æ¼«": "A5", "ç›¼ç›¼": "5", "å’ªå°çª": "5" }, "#943630": { "MARD": "F06", "COCO": "Z21", "æ¼«æ¼«": "E9", "ç›¼ç›¼": "16", "å’ªå°çª": "16" }, "#971937": { "MARD": "F07", "COCO": "C10", "æ¼«æ¼«": "A6", "ç›¼ç›¼": "47", "å’ªå°çª": "47" }, "#BC0028": { "MARD": "F08", "COCO": "C09", "æ¼«æ¼«": "A17", "ç›¼ç›¼": "81", "å’ªå°çª": "92" }, "#E2677A": { "MARD": "F09", "COCO": "K20", "æ¼«æ¼«": "A15", "ç›¼ç›¼": "82", "å’ªå°çª": "93" }, "#8A4526": { "MARD": "F10", "COCO": "Z20", "æ¼«æ¼«": "E15", "ç›¼ç›¼": "116", "å’ªå°çª": "115" }, "#5A2121": { "MARD": "F11", "COCO": "Z23", "æ¼«æ¼«": "E16", "ç›¼ç›¼": "117", "å’ªå°çª": "129" }, "#FD4E6A": { "MARD": "F12", "COCO": "C01", "æ¼«æ¼«": "A22", "ç›¼ç›¼": "136", "å’ªå°çª": "134" }, "#F35744": { "MARD": "F13", "COCO": "C04", "æ¼«æ¼«": "A24", "ç›¼ç›¼": "148", "å’ªå°çª": "148" }, "#FFA9AD": { "MARD": "F14", "COCO": "K07", "æ¼«æ¼«": "A25", "ç›¼ç›¼": "154", "å’ªå°çª": "154" }, "#D30022": { "MARD": "F15", "COCO": "C08", "æ¼«æ¼«": "DH8", "ç›¼ç›¼": "204", "å’ªå°çª": "191" }, "#FEC2A6": { "MARD": "F16", "COCO": "K06", "æ¼«æ¼«": "IC10", "ç›¼ç›¼": "211", "å’ªå°çª": "211" }, "#E69C79": { "MARD": "F17", "COCO": "K31", "æ¼«æ¼«": "Q9", "ç›¼ç›¼": "245", "å’ªå°çª": "245" }, "#D37C46": { "MARD": "F18", "COCO": "K32", "æ¼«æ¼«": "Q10", "ç›¼ç›¼": "246", "å’ªå°çª": "246" }, "#C1444A": { "MARD": "F19", "COCO": "K33", "æ¼«æ¼«": "Q05", "ç›¼ç›¼": "243", "å’ªå°çª": "243" }, "#CD9391": { "MARD": "F20", "COCO": "K34", "æ¼«æ¼«": "R04", "ç›¼ç›¼": "275", "å’ªå°çª": "260" }, "#F7B4C6": { "MARD": "F21", "COCO": "K35", "æ¼«æ¼«": "R03", "ç›¼ç›¼": "266", "å’ªå°çª": "251" }, "#FDC0D0": { "MARD": "F22", "COCO": "K36", "æ¼«æ¼«": "R02", "ç›¼ç›¼": "272", "å’ªå°çª": "257" }, "#F67E66": { "MARD": "F23", "COCO": "K37", "æ¼«æ¼«": "R05", "ç›¼ç›¼": "264", "å’ªå°çª": "249" }, "#E698AA": { "MARD": "F24", "COCO": "K38", "æ¼«æ¼«": "G9", "ç›¼ç›¼": "283", "å’ªå°çª": "268" }, "#E54B4F": { "MARD": "F25", "COCO": "K39", "æ¼«æ¼«": "G10", "ç›¼ç›¼": "284", "å’ªå°çª": "269" }, "#FFE2CE": { "MARD": "G01", "COCO": "Z02", "æ¼«æ¼«": "E3", "ç›¼ç›¼": "76", "å’ªå°çª": "81" }, "#FFC4AA": { "MARD": "G02", "COCO": "Z05", "æ¼«æ¼«": "E4", "ç›¼ç›¼": "49", "å’ªå°çª": "49" }, "#F4C3A5": { "MARD": "G03", "COCO": "Z06", "æ¼«æ¼«": "E5", "ç›¼ç›¼": "80", "å’ªå°çª": "85" }, "#E1B383": { "MARD": "G04", "COCO": "Z08", "æ¼«æ¼«": "E6", "ç›¼ç›¼": "19", "å’ªå°çª": "19" }, "#EDB045": { "MARD": "G05", "COCO": "Z10", "æ¼«æ¼«": "B7", "ç›¼ç›¼": "43", "å’ªå°çª": "43" }, "#E99C17": { "MARD": "G06", "COCO": "Z11", "æ¼«æ¼«": "B8", "ç›¼ç›¼": "50", "å’ªå°çª": "50" }, "#9D5B3E": { "MARD": "G07", "COCO": "Z18", "æ¼«æ¼«": "E7", "ç›¼ç›¼": "17", "å’ªå°çª": "17" }, "#753832": { "MARD": "G08", "COCO": "Z22", "æ¼«æ¼«": "E8", "ç›¼ç›¼": "12", "å’ªå°çª": "12" }, "#E6B483": { "MARD": "G09", "COCO": "Z09", "æ¼«æ¼«": "E10", "ç›¼ç›¼": "91", "å’ªå°çª": "102" }, "#D98C39": { "MARD": "G10", "COCO": "Z15", "æ¼«æ¼«": "B9", "ç›¼ç›¼": "87", "å’ªå°çª": "101" }, "#E0C593": { "MARD": "G11", "COCO": "Z07", "æ¼«æ¼«": "E12", "ç›¼ç›¼": "112", "å’ªå°çª": "118" }, "#FFC890": { "MARD": "G12", "COCO": "Z13", "æ¼«æ¼«": "E13", "ç›¼ç›¼": "113", "å’ªå°çª": "127" }, "#B7714A": { "MARD": "G13", "COCO": "Z14", "æ¼«æ¼«": "E17", "ç›¼ç›¼": "115", "å’ªå°çª": "114" }, "#8D614C": { "MARD": "G14", "COCO": "Z17", "æ¼«æ¼«": "E14", "ç›¼ç›¼": "114", "å’ªå°çª": "123" }, "#FCF9E0": { "MARD": "G15", "COCO": "Z03", "æ¼«æ¼«": "E19", "ç›¼ç›¼": "133", "å’ªå°çª": "143" }, "#F2D9BA": { "MARD": "G16", "COCO": "Z04", "æ¼«æ¼«": "E20", "ç›¼ç›¼": "134", "å’ªå°çª": "138" }, "#78524B": { "MARD": "G17", "COCO": "Z16", "æ¼«æ¼«": "E22", "ç›¼ç›¼": "144", "å’ªå°çª": "137" }, "#FFE4CC": { "MARD": "G18", "COCO": "Z01", "æ¼«æ¼«": "DH5", "ç›¼ç›¼": "203", "å’ªå°çª": "203" }, "#E07935": { "MARD": "G19", "COCO": "Z12", "æ¼«æ¼«": "DH3", "ç›¼ç›¼": "208", "å’ªå°çª": "195" }, "#A94023": { "MARD": "G20", "COCO": "Z19", "æ¼«æ¼«": "DH13", "ç›¼ç›¼": "199", "å’ªå°çª": "199" }, "#B88558": { "MARD": "G21", "COCO": "Z24", "æ¼«æ¼«": "Q8", "ç›¼ç›¼": "247", "å’ªå°çª": "247" }, "#FDFBFF": { "MARD": "H01", "COCO": "A02", "æ¼«æ¼«": "F1", "ç›¼ç›¼": "15", "å’ªå°çª": "15" }, "#FEFFFF": { "MARD": "H02", "COCO": "A01", "æ¼«æ¼«": "F2", "ç›¼ç›¼": "1", "å’ªå°çª": "1" }, "#B6B1BA": { "MARD": "H03", "COCO": "B03", "æ¼«æ¼«": "F3", "ç›¼ç›¼": "13", "å’ªå°çª": "13" }, "#89858C": { "MARD": "H04", "COCO": "B05", "æ¼«æ¼«": "F4", "ç›¼ç›¼": "78", "å’ªå°çª": "83" }, "#48464E": { "MARD": "H05", "COCO": "B06", "æ¼«æ¼«": "F5", "ç›¼ç›¼": "45", "å’ªå°çª": "45" }, "#2F2B2F": { "MARD": "H06", "COCO": "B07", "æ¼«æ¼«": "F6", "ç›¼ç›¼": "51", "å’ªå°çª": "70" }, "#000000": { "MARD": "H07", "COCO": "B09", "æ¼«æ¼«": "F7", "ç›¼ç›¼": "14", "å’ªå°çª": "14" }, "#E7D6DB": { "MARD": "H08", "COCO": "A09", "æ¼«æ¼«": "F8", "ç›¼ç›¼": "85", "å’ªå°çª": "86" }, "#EDEDED": { "MARD": "H09", "COCO": "A08", "æ¼«æ¼«": "F10", "ç›¼ç›¼": "95", "å’ªå°çª": "87" }, "#EEE9EA": { "MARD": "H10", "COCO": "A10", "æ¼«æ¼«": "F9", "ç›¼ç›¼": "86", "å’ªå°çª": "88" }, "#CECDD5": { "MARD": "H11", "COCO": "B01", "æ¼«æ¼«": "F11", "ç›¼ç›¼": "123", "å’ªå°çª": "121" }, "#FFF5ED": { "MARD": "H12", "COCO": "A04", "æ¼«æ¼«": "E18", "ç›¼ç›¼": "132", "å’ªå°çª": "144" }, "#F5ECD2": { "MARD": "H13", "COCO": "A06", "æ¼«æ¼«": "E23", "ç›¼ç›¼": "145", "å’ªå°çª": "146" }, "#CFD7D3": { "MARD": "H14", "COCO": "B02", "æ¼«æ¼«": "F12", "ç›¼ç›¼": "146", "å’ªå°çª": "145" }, "#98A6A8": { "MARD": "H15", "COCO": "B04", "æ¼«æ¼«": "DH4", "ç›¼ç›¼": "201", "å’ªå°çª": "201" }, "#1D1414": { "MARD": "H16", "COCO": "B08", "æ¼«æ¼«": "DH11", "ç›¼ç›¼": "200", "å’ªå°çª": "200" }, "#F1EDED": { "MARD": "H17", "COCO": "A07", "æ¼«æ¼«": "IC6", "ç›¼ç›¼": "214", "å’ªå°çª": "214" }, "#FFFDF0": { "MARD": "H18", "COCO": "A03", "æ¼«æ¼«": "IC1", "ç›¼ç›¼": "219", "å’ªå°çª": "204" }, "#F6EFE2": { "MARD": "H19", "COCO": "A05", "æ¼«æ¼«": "IC11", "ç›¼ç›¼": "209", "å’ªå°çª": "209" }, "#949FA3": { "MARD": "H20", "COCO": "B10", "æ¼«æ¼«": "Q12", "ç›¼ç›¼": "251", "å’ªå°çª": "236" }, "#FFFBE1": { "MARD": "H21", "COCO": "A11", "æ¼«æ¼«": "G1", "ç›¼ç›¼": "291", "å’ªå°çª": "276" }, "#CACAD4": { "MARD": "H22", "COCO": "A12", "æ¼«æ¼«": "G2", "ç›¼ç›¼": "277", "å’ªå°çª": "277" }, "#9A9D94": { "MARD": "H23", "COCO": "B11", "æ¼«æ¼«": "G11", "ç›¼ç›¼": "278", "å’ªå°çª": "278" }, "#BCC6B8": { "MARD": "M01", "COCO": "Y01", "æ¼«æ¼«": "YX11", "ç›¼ç›¼": "168", "å’ªå°çª": "168" }, "#8AA386": { "MARD": "M02", "COCO": "Y02", "æ¼«æ¼«": "YX12", "ç›¼ç›¼": "172", "å’ªå°çª": "172" }, "#697D80": { "MARD": "M03", "COCO": "Y03", "æ¼«æ¼«": "YX2", "ç›¼ç›¼": "166", "å’ªå°çª": "166" }, "#E3D2BC": { "MARD": "M04", "COCO": "Y04", "æ¼«æ¼«": "YX15", "ç›¼ç›¼": "167", "å’ªå°çª": "167" }, "#D0CCAA": { "MARD": "M05", "COCO": "Y05", "æ¼«æ¼«": "YX6", "ç›¼ç›¼": "174", "å’ªå°çª": "159" }, "#B0A782": { "MARD": "M06", "COCO": "Y06", "æ¼«æ¼«": "YX1", "ç›¼ç›¼": "169", "å’ªå°çª": "169" }, "#B4A497": { "MARD": "M07", "COCO": "Y07", "æ¼«æ¼«": "YX13", "ç›¼ç›¼": "171", "å’ªå°çª": "171" }, "#B38281": { "MARD": "M08", "COCO": "Y08", "æ¼«æ¼«": "YX14", "ç›¼ç›¼": "177", "å’ªå°çª": "162" }, "#A58767": { "MARD": "M09", "COCO": "Y09", "æ¼«æ¼«": "YX10", "ç›¼ç›¼": "170", "å’ªå°çª": "170" }, "#C5B2BC": { "MARD": "M10", "COCO": "Y10", "æ¼«æ¼«": "YX9", "ç›¼ç›¼": "164", "å’ªå°çª": "164" }, "#9F7594": { "MARD": "M11", "COCO": "Y11", "æ¼«æ¼«": "YX4", "ç›¼ç›¼": "176", "å’ªå°çª": "161" }, "#644749": { "MARD": "M12", "COCO": "Y12", "æ¼«æ¼«": "YX5", "ç›¼ç›¼": "173", "å’ªå°çª": "173" }, "#D19066": { "MARD": "M13", "COCO": "Y13", "æ¼«æ¼«": "YX8", "ç›¼ç›¼": "175", "å’ªå°çª": "160" }, "#C77362": { "MARD": "M14", "COCO": "Y14", "æ¼«æ¼«": "YX3", "ç›¼ç›¼": "165", "å’ªå°çª": "165" }, "#757D78": { "MARD": "M15", "COCO": "Y15", "æ¼«æ¼«": "YX7", "ç›¼ç›¼": "178", "å’ªå°çª": "163" }, "#FCF7F8": { "MARD": "P01", "COCO": "M01", "æ¼«æ¼«": "P1", "ç›¼ç›¼": "71", "å’ªå°çª": "62" }, "#B0A9AC": { "MARD": "P02", "COCO": "M02", "æ¼«æ¼«": "P2", "ç›¼ç›¼": "55", "å’ªå°çª": "69" }, "#AFDCAB": { "MARD": "P03", "COCO": "M03", "æ¼«æ¼«": "P4", "ç›¼ç›¼": "73", "å’ªå°çª": "66" }, "#FEA49F": { "MARD": "P04", "COCO": "M04", "æ¼«æ¼«": "P5", "ç›¼ç›¼": "72", "å’ªå°çª": "64" }, "#EE8C3E": { "MARD": "P05", "COCO": "M05", "æ¼«æ¼«": "P3", "ç›¼ç›¼": "56", "å’ªå°çª": "63" }, "#5FD0A7": { "MARD": "P06", "COCO": "M06", "æ¼«æ¼«": "P8", "ç›¼ç›¼": "157", "å’ªå°çª": "65" }, "#EB9270": { "MARD": "P07", "COCO": "M07", "æ¼«æ¼«": "P6", "ç›¼ç›¼": "159", "å’ªå°çª": "68" }, "#F0D958": { "MARD": "P08", "COCO": "M08", "æ¼«æ¼«": "P7", "ç›¼ç›¼": "158", "å’ªå°çª": "67" }, "#D9D9D9": { "MARD": "P09", "COCO": "M09", "æ¼«æ¼«": "P13", "ç›¼ç›¼": "195", "å’ªå°çª": "178" }, "#D9C7EA": { "MARD": "P10", "COCO": "M10", "æ¼«æ¼«": "P18", "ç›¼ç›¼": "187", "å’ªå°çª": "187" }, "#F3ECC9": { "MARD": "P11", "COCO": "M11", "æ¼«æ¼«": "P9", "ç›¼ç›¼": "185", "å’ªå°çª": "185" }, "#E6EEF2": { "MARD": "P12", "COCO": "M12", "æ¼«æ¼«": "P12", "ç›¼ç›¼": "190", "å’ªå°çª": "190" }, "#AACBEF": { "MARD": "P13", "COCO": "M13", "æ¼«æ¼«": "P17", "ç›¼ç›¼": "193", "å’ªå°çª": "176" }, "#337680": { "MARD": "P14", "COCO": "M14", "æ¼«æ¼«": "P22", "ç›¼ç›¼": "183", "å’ªå°çª": "183" }, "#668575": { "MARD": "P15", "COCO": "M15", "æ¼«æ¼«": "P23", "ç›¼ç›¼": "184", "å’ªå°çª": "184" }, "#FEBF45": { "MARD": "P16", "COCO": "M16", "æ¼«æ¼«": "P14", "ç›¼ç›¼": "182", "å’ªå°çª": "182" }, "#FEA324": { "MARD": "P17", "COCO": "M17", "æ¼«æ¼«": "P19", "ç›¼ç›¼": "179", "å’ªå°çª": "179" }, "#FEB89F": { "MARD": "P18", "COCO": "M18", "æ¼«æ¼«": "P11", "ç›¼ç›¼": "194", "å’ªå°çª": "177" }, "#FFFEEC": { "MARD": "P19", "COCO": "M19", "æ¼«æ¼«": "P10", "ç›¼ç›¼": "186", "å’ªå°çª": "186" }, "#FEBECF": { "MARD": "P20", "COCO": "M21", "æ¼«æ¼«": "P15", "ç›¼ç›¼": "188", "å’ªå°çª": "180" }, "#ECBEBF": { "MARD": "P21", "COCO": "M20", "æ¼«æ¼«": "P20", "ç›¼ç›¼": "180", "å’ªå°çª": "188" }, "#E4A89F": { "MARD": "P22", "COCO": "M22", "æ¼«æ¼«": "P16", "ç›¼ç›¼": "189", "å’ªå°çª": "189" }, "#A56268": { "MARD": "P23", "COCO": "M23", "æ¼«æ¼«": "P21", "ç›¼ç›¼": "181", "å’ªå°çª": "181" }, "#F2A5E8": { "MARD": "Q01", "COCO": "W3", "æ¼«æ¼«": "W3", "ç›¼ç›¼": "109", "å’ªå°çª": "W3" }, "#E9EC91": { "MARD": "Q02", "COCO": "W4", "æ¼«æ¼«": "W4", "ç›¼ç›¼": "111", "å’ªå°çª": "W4" }, "#FFFF00": { "MARD": "Q03", "COCO": "W1", "æ¼«æ¼«": "W1", "ç›¼ç›¼": "107", "å’ªå°çª": "W1" }, "#FFEBFA": { "MARD": "Q04", "COCO": "W2", "æ¼«æ¼«": "W2", "ç›¼ç›¼": "110", "å’ªå°çª": "W2" }, "#76CEDE": { "MARD": "Q05", "COCO": "W5", "æ¼«æ¼«": "W5", "ç›¼ç›¼": "108", "å’ªå°çª": "W5" }, "#D50D21": { "MARD": "R01", "COCO": "L01", "æ¼«æ¼«": "T1", "ç›¼ç›¼": "67", "å’ªå°çª": "52" }, "#F92F83": { "MARD": "R02", "COCO": "L02", "æ¼«æ¼«": "N1", "ç›¼ç›¼": "24", "å’ªå°çª": "24" }, "#FD8324": { "MARD": "R03", "COCO": "L03", "æ¼«æ¼«": "N2", "ç›¼ç›¼": "22", "å’ªå°çª": "22" }, "#F8EC31": { "MARD": "R04", "COCO": "L04", "æ¼«æ¼«": "N3", "ç›¼ç›¼": "21", "å’ªå°çª": "21" }, "#35C75B": { "MARD": "R05", "COCO": "L05", "æ¼«æ¼«": "N4", "ç›¼ç›¼": "23", "å’ªå°çª": "23" }, "#238891": { "MARD": "R06", "COCO": "L06", "æ¼«æ¼«": "T4", "ç›¼ç›¼": "69", "å’ªå°çª": "55" }, "#19779D": { "MARD": "R07", "COCO": "L07", "æ¼«æ¼«": "T5", "ç›¼ç›¼": "37", "å’ªå°çª": "37" }, "#1A60C3": { "MARD": "R08", "COCO": "L08", "æ¼«æ¼«": "T3", "ç›¼ç›¼": "68", "å’ªå°çª": "54" }, "#9A56B4": { "MARD": "R09", "COCO": "L09", "æ¼«æ¼«": "T2", "ç›¼ç›¼": "70", "å’ªå°çª": "56" }, "#FFDB4C": { "MARD": "R10", "COCO": "L10", "æ¼«æ¼«": "L2", "ç›¼ç›¼": "156", "å’ªå°çª": "53" }, "#FFEBFB": { "MARD": "R11", "COCO": "L11", "æ¼«æ¼«": "T6", "ç›¼ç›¼": "151", "å’ªå°çª": "151" }, "#D8D5CE": { "MARD": "R12", "COCO": "L12", "æ¼«æ¼«": "T7", "ç›¼ç›¼": "160", "å’ªå°çª": "157" }, "#55514C": { "MARD": "R13", "COCO": "L13", "æ¼«æ¼«": "-", "ç›¼ç›¼": "152", "å’ªå°çª": "152" }, "#9FE4DF": { "MARD": "R14", "COCO": "S1", "æ¼«æ¼«": "S1", "ç›¼ç›¼": "231", "å’ªå°çª": "231" }, "#77CEE9": { "MARD": "R15", "COCO": "S2", "æ¼«æ¼«": "S2", "ç›¼ç›¼": "237", "å’ªå°çª": "224" }, "#3ECFCA": { "MARD": "R16", "COCO": "S3", "æ¼«æ¼«": "S3", "ç›¼ç›¼": "238", "å’ªå°çª": "225" }, "#4A867A": { "MARD": "R17", "COCO": "S4", "æ¼«æ¼«": "S5", "ç›¼ç›¼": "233", "å’ªå°çª": "233" }, "#7FCD9D": { "MARD": "R18", "COCO": "S5", "æ¼«æ¼«": "S4", "ç›¼ç›¼": "235", "å’ªå°çª": "222" }, "#CDE55D": { "MARD": "R19", "COCO": "S6", "æ¼«æ¼«": "S11", "ç›¼ç›¼": "227", "å’ªå°çª": "227" }, "#E8C7B4": { "MARD": "R20", "COCO": "S7", "æ¼«æ¼«": "S6", "ç›¼ç›¼": "230", "å’ªå°çª": "230" }, "#AD6F3C": { "MARD": "R21", "COCO": "S8", "æ¼«æ¼«": "S13", "ç›¼ç›¼": "234", "å’ªå°çª": "221" }, "#6C372F": { "MARD": "R22", "COCO": "S9", "æ¼«æ¼«": "S15", "ç›¼ç›¼": "226", "å’ªå°çª": "226" }, "#FEB872": { "MARD": "R23", "COCO": "S10", "æ¼«æ¼«": "S12", "ç›¼ç›¼": "224", "å’ªå°çª": "219" }, "#F3C1C0": { "MARD": "R24", "COCO": "S11", "æ¼«æ¼«": "S4", "ç›¼ç›¼": "228", "å’ªå°çª": "228" }, "#C9675E": { "MARD": "R25", "COCO": "S12", "æ¼«æ¼«": "S14", "ç›¼ç›¼": "225", "å’ªå°çª": "220" }, "#D293BE": { "MARD": "R26", "COCO": "S13", "æ¼«æ¼«": "S9", "ç›¼ç›¼": "229", "å’ªå°çª": "229" }, "#EA8CB1": { "MARD": "R27", "COCO": "S14", "æ¼«æ¼«": "S8", "ç›¼ç›¼": "232", "å’ªå°çª": "232" }, "#9C87D6": { "MARD": "R28", "COCO": "S15", "æ¼«æ¼«": "S10", "ç›¼ç›¼": "236", "å’ªå°çª": "223" }, "#FFFFFF": { "MARD": "T01", "COCO": "L14", "æ¼«æ¼«": "L6", "ç›¼ç›¼": "155", "å’ªå°çª": "51" }, "#FD6FB4": { "MARD": "Y01", "COCO": "N01", "æ¼«æ¼«": "Y1", "ç›¼ç›¼": "59", "å’ªå°çª": "59" }, "#FEB481": { "MARD": "Y02", "COCO": "N02", "æ¼«æ¼«": "Y2", "ç›¼ç›¼": "60", "å’ªå°çª": "60" }, "#D7FAA0": { "MARD": "Y03", "COCO": "N03", "æ¼«æ¼«": "Y3", "ç›¼ç›¼": "57", "å’ªå°çª": "57" }, "#8BDBFA": { "MARD": "Y04", "COCO": "N04", "æ¼«æ¼«": "Y4", "ç›¼ç›¼": "58", "å’ªå°çª": "58" }, "#E987EA": { "MARD": "Y05", "COCO": "N05", "æ¼«æ¼«": "Y5", "ç›¼ç›¼": "61", "å’ªå°çª": "61" }, "#DAABB3": { "MARD": "ZG1", "COCO": "GB1", "æ¼«æ¼«": "ZG1", "ç›¼ç›¼": "254", "å’ªå°çª": "ZG1" }, "#D6AA87": { "MARD": "ZG2", "COCO": "GB2", "æ¼«æ¼«": "ZG2", "ç›¼ç›¼": "255", "å’ªå°çª": "ZG2" }, "#C1BD8D": { "MARD": "ZG3", "COCO": "GB3", "æ¼«æ¼«": "ZG3", "ç›¼ç›¼": "256", "å’ªå°çª": "ZG3" }, "#96869F": { "MARD": "ZG4", "COCO": "GB4", "æ¼«æ¼«": "ZG4", "ç›¼ç›¼": "257", "å’ªå°çª": "ZG4" }, "#8490A6": { "MARD": "ZG5", "COCO": "GB5", "æ¼«æ¼«": "ZG5", "ç›¼ç›¼": "258", "å’ªå°çª": "ZG5" }, "#94BFE2": { "MARD": "ZG6", "COCO": "GB6", "æ¼«æ¼«": "ZG6", "ç›¼ç›¼": "259", "å’ªå°çª": "ZG6" }, "#E2A9D2": { "MARD": "ZG7", "COCO": "GB7", "æ¼«æ¼«": "ZG7", "ç›¼ç›¼": "260", "å’ªå°çª": "ZG7" }, "#AB91C0": { "MARD": "ZG8", "COCO": "GB8", "æ¼«æ¼«": "ZG8", "ç›¼ç›¼": "261", "å’ªå°çª": "ZG8" } }

                    this.optimizer = new ColorOptimizer(new OptimizationConfig());
                    this.optimizer.loadColors(data);

                    this.log('âœ… é¢œè‰²æ•°æ®åŠ è½½å®Œæˆ', 'success');
                    this.log(`å·²åŠ è½½ ${this.optimizer.hexList.length} ä¸ªé¢œè‰²`, 'success');

                    loading.style.display = 'none';
                    startBtn.disabled = false;

                } catch (error) {
                    this.log('âŒ åŠ è½½é¢œè‰²æ•°æ®å¤±è´¥: ' + error.message, 'error');
                    loading.innerHTML = `
                        <div style="color: #ef4444; text-align: center;">
                            <p style="font-size: 24px;">âš ï¸</p>
                            <p>æ— æ³•åŠ è½½é¢œè‰²æ•°æ®</p>
                            <p style="color: var(--text-muted); font-size: 14px;">è¯·ç¡®ä¿æ‹¼è±†é¢œè‰²åˆ—è¡¨.jsonæ–‡ä»¶å­˜åœ¨</p>
                        </div>
                    `;
                }
            }

            bindEvents() {
                document.getElementById('start-btn').addEventListener('click', () => {
                    this.startOptimization();
                });

                document.getElementById('code-type').addEventListener('change', () => {
                    this.updateDisplay();
                });

                document.getElementById('show-hex').addEventListener('change', () => {
                    this.updateDisplay();
                });

                document.getElementById('show-names').addEventListener('change', () => {
                    this.updateDisplay();
                });

                // Mode Switching
                const modeRadios = document.querySelectorAll('input[name="source-mode"]');
                modeRadios.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        const mode = e.target.value;
                        const uploadGroup = document.getElementById('image-upload-group');
                        const previewContainer = document.getElementById('image-preview-container');

                        if (mode === 'IMAGE') {
                            uploadGroup.style.display = 'block';
                            if (this.uploadedImage) previewContainer.style.display = 'block';
                        } else {
                            uploadGroup.style.display = 'none';
                            previewContainer.style.display = 'none';
                        }
                    });
                });

                // Image Upload
                document.getElementById('image-upload').addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    try {
                        const img = await this.imageProcessor.loadImage(file);
                        this.uploadedImage = img;

                        // Update preview
                        const previewImg = document.getElementById('source-image-preview');
                        previewImg.src = img.src;
                        document.getElementById('image-preview-container').style.display = 'block';

                        this.log('âœ… å›¾ç‰‡åŠ è½½æˆåŠŸ', 'success');
                    } catch (err) {
                        this.log('âŒ å›¾ç‰‡åŠ è½½å¤±è´¥', 'error');
                        console.error(err);
                    }
                });

                // Export Functionality
                const dialog = document.getElementById('export-dialog');
                const textarea = document.getElementById('export-textarea');

                document.getElementById('export-btn').addEventListener('click', () => {
                    if (!this.optimizer || !this.optimizer.bestState) {
                        alert('è¯·å…ˆè¿è¡Œä¼˜åŒ–ï¼');
                        return;
                    }
                    dialog.style.display = 'flex';
                    this.updateExportContent();
                });

                document.getElementById('close-dialog-btn').addEventListener('click', () => {
                    dialog.style.display = 'none';
                });

                document.getElementById('copy-btn').addEventListener('click', () => {
                    textarea.select();
                    document.execCommand('copy');
                    const originalText = document.getElementById('copy-btn').textContent;
                    document.getElementById('copy-btn').textContent = 'å·²å¤åˆ¶!';
                    setTimeout(() => {
                        document.getElementById('copy-btn').textContent = originalText;
                    }, 2000);
                });

                const formatSelect = document.getElementById('export-format');
                formatSelect.addEventListener('change', () => {
                    this.updateExportContent();
                });
            }

            updateExportContent() {
                const format = document.getElementById('export-format').value;
                const textarea = document.getElementById('export-textarea');
                const finalSet = new Set([...this.optimizer.bestState, ...this.optimizer.getFixedIndices()]);
                const codeType = document.getElementById('code-type').value;

                let content = '';
                const sortedIndices = Array.from(finalSet).sort((a, b) => {
                    const codeA = this.optimizer.getColorCodes(codeType, this.optimizer.hexList[a]) || '';
                    const codeB = this.optimizer.getColorCodes(codeType, this.optimizer.hexList[b]) || '';
                    return codeA.localeCompare(codeB);
                });

                if (format === 'JSON') {
                    const selectedHexValues = sortedIndices.map(i => this.optimizer.hexList[i]);
                    const data = {
                        "version": "3.0",
                        "selectedHexValues": selectedHexValues,
                        "exportDate": new Date().toISOString(),
                        "totalColors": selectedHexValues.length
                    };
                    content = JSON.stringify(data, null, 2);
                } else if (format === 'HEX') {
                    content = sortedIndices.map(i => this.optimizer.hexList[i]).join('\n');
                } else if (format === 'CODE') {
                    content = sortedIndices.map(i => {
                        const hex = this.optimizer.hexList[i];
                        return this.optimizer.getColorCodes(codeType, hex) || this.optimizer.codeMaps.MARD.get(hex);
                    }).join('\n');
                }

                textarea.value = content;
            }

            log(message, type = 'info') {
                const logBox = document.getElementById('log-box');
                const logLine = document.createElement('div');
                logLine.className = `log-line ${type}`;
                logLine.textContent = message;
                logBox.appendChild(logLine);
                logBox.scrollTop = logBox.scrollHeight;
            }

            async startOptimization() {
                if (!this.optimizer) {
                    this.log('âŒ ä¼˜åŒ–å™¨æœªåˆå§‹åŒ–', 'error');
                    return;
                }

                if (this.optimizer.isRunning) {
                    this.optimizer.stop();
                    this.currentAnimation = null;
                    document.getElementById('start-btn').textContent = 'å¼€å§‹ä¼˜åŒ–';
                    this.log('â¸ï¸ ä¼˜åŒ–å·²åœæ­¢', 'warning');
                    return;
                }

                const startBtn = document.getElementById('start-btn');
                startBtn.textContent = 'åœæ­¢ä¼˜åŒ–';
                startBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';

                this.log('='.repeat(50));
                this.log(`ğŸš€ å¼€å§‹ä¼˜åŒ– (ç§å­: ${document.getElementById('seed-input').value})`);
                this.log(`é¢œæ–™é¢„ç®—: ${document.getElementById('k-input').value}`);
                this.log(`ğŸš€ å¼€å§‹ä¼˜åŒ– (ç§å­: ${document.getElementById('seed-input').value})`);
                this.log(`æ¨¡å¼: ${document.getElementById('target-mode').value === 'MAX' ? 'æœ€å¤§ Î”E' : 'å¹³å‡ Î”E'}`);
                this.log(`é¢œæ–™é¢„ç®—: ${document.getElementById('k-input').value}`);
                this.log(`é€€ç«æ­¥æ•°: ${document.getElementById('steps-input').value}`);
                this.log('='.repeat(50));

                document.getElementById('log-box').innerHTML = '';
                document.getElementById('progress-fill').style.width = '0%';
                document.getElementById('progress-text').textContent = '0%';

                try {
                    // Pre-optimization setup
                    if (document.querySelector('input[name="source-mode"]:checked').value === 'IMAGE') {
                        if (!this.uploadedImage) {
                            throw new Error("è¯·å…ˆä¸Šä¼ å‚è€ƒå›¾ç‰‡");
                        }
                        this.log('æ­£åœ¨é‡‡æ ·å›¾ç‰‡é¢œè‰²...', 'info');
                        const samples = this.imageProcessor.sampleColors(this.uploadedImage);
                        this.log(`âœ… å·²é‡‡æ · ${samples.length} ä¸ªåƒç´ ç‚¹`, 'success');
                        document.getElementById('sample-count-display').textContent = samples.length;

                        // Convert samples to Lab
                        const targetLabs = samples.map(rgb => this.optimizer.rgbToLab(rgb));
                        this.optimizer.setTargetColors(targetLabs);
                    } else {
                        // Global mode: Targets = Candidates
                        this.optimizer.setTargetColors(this.optimizer.candidateLabColors);
                    }

                    const saGenerator = this.optimizer.simulatedAnnealing();

                    for await (const update of this.runAnimationFrame(saGenerator)) {
                        switch (update.type) {
                            case 'initialized':
                                this.log(`âœ… åˆå§‹åŒ–å®Œæˆï¼Œåˆå§‹è¯¯å·®: ${update.bestError.toFixed(2)}`, 'success');
                                this.displayResults(update.currentState, update.fixedIndices);
                                break;

                            case 'progress':
                                this.updateProgress(update);
                                this.displayResults(update.currentState, update.fixedIndices);
                                break;

                            case 'completed':
                                this.onOptimizationComplete(update);
                                break;
                        }
                    }
                } catch (error) {
                    this.log(`âŒ ä¼˜åŒ–è¿‡ç¨‹å‡ºé”™: ${error.message}`, 'error');
                } finally {
                    startBtn.textContent = 'å¼€å§‹ä¼˜åŒ–';
                    startBtn.style.background = 'linear-gradient(135deg, #3b82f6, #8b5cf6)';
                }
            }

            async *runAnimationFrame(generator) {
                for await (const value of generator) {
                    yield value;
                    await new Promise(resolve => setTimeout(resolve, 0));
                }
            }

            updateProgress(update) {
                const progressFill = document.getElementById('progress-fill');
                const progressText = document.getElementById('progress-text');
                const progress = update.progress;

                progressFill.style.width = `${progress}%`;
                progressText.textContent = `${progress.toFixed(1)}%`;

                // Update stats
                document.getElementById('current-min').textContent = update.stats.min.toFixed(2);
                document.getElementById('current-max').textContent = update.stats.max.toFixed(2);
                document.getElementById('current-avg').textContent = update.stats.avg.toFixed(2);

                document.getElementById('best-error').textContent = update.bestError.toFixed(2);

                const modeValues = {
                    'MAX': 'æœ€ä½³æœ€å¤§Î”E',
                    'AVG': 'æœ€ä½³å¹³å‡Î”E'
                };
                const currentMode = document.getElementById('target-mode').value;
                document.getElementById('best-error-label').textContent = modeValues[currentMode];

                document.getElementById('temperature').textContent =
                    update.temperature.toExponential(2);
                document.getElementById('step-count').textContent =
                    update.step.toLocaleString();

                if (update.step % 5000 === 0) {
                    this.log(`step ${update.step.toString().padStart(6)} | T=${update.temperature.toExponential(3)} | best err=${update.bestError.toFixed(2)}`);
                }
            }

            onOptimizationComplete(result) {
                this.log('='.repeat(50));
                this.log('âœ… ä¼˜åŒ–å®Œæˆï¼', 'success');
                this.log(`æœ€ç»ˆæœ€å¤§ Î”E: ${result.bestError.toFixed(2)}`, 'success');
                this.log(`æ€»å…±é€‰æ‹©äº† ${result.bestState.size + result.fixedIndices.size} ä¸ªé¢œè‰²`, 'success');
                this.log('='.repeat(50));

                this.displayResults(result.bestState, result.fixedIndices);
            }

            displayResults(currentState, fixedIndices) {
                const finalSet = new Set([...currentState, ...fixedIndices]);
                const codeType = document.getElementById('code-type').value;
                const showHex = document.getElementById('show-hex').checked;
                const showNames = document.getElementById('show-names').checked;

                const results = [];
                for (const idx of finalSet) {
                    const hex = this.optimizer.hexList[idx];
                    const colorInfo = this.optimizer.colors.find(c => c.hex === hex);
                    const code = this.optimizer.getColorCodes(codeType, hex) ||
                        this.optimizer.codeMaps.MARD.get(hex);

                    results.push({
                        hex: hex,
                        code: code,
                        name: colorInfo?.name || '',
                        isMandatory: fixedIndices.has(idx)
                    });
                }

                results.sort((a, b) => a.code.localeCompare(b.code));

                document.getElementById('result-title').textContent =
                    `ğŸ¨ ä¼˜åŒ–ç»“æœ (${results.length} ä¸ªé¢œè‰²)`;
                document.getElementById('current-colors-count').textContent = results.length;

                const colorGrid = document.getElementById('color-grid');
                colorGrid.innerHTML = '';

                results.forEach((item, index) => {
                    const card = this.createColorCard(item, showHex, showNames, index);
                    colorGrid.appendChild(card);
                });
            }

            createColorCard(color, showHex, showNames, index) {
                const card = document.createElement('div');
                card.className = 'color-card';
                if (index === 0) card.classList.add('current-color');

                const rgb = this.optimizer.hexToRgb(color.hex);
                const luminance = (0.299 * rgb[0] + 0.587 * rgb[1] + 0.114 * rgb[2]) / 255;
                const textColor = luminance > 0.5 ? '#0f172a' : '#f1f5f9';

                let infoHTML = '';
                infoHTML += `<div class="color-id" style="color: ${textColor}">${color.code}</div>`;
                if (showNames && color.name) {
                    infoHTML += `<div class="color-name" style="color: ${textColor}">${color.name}</div>`;
                }
                if (showHex) {
                    infoHTML += `<div class="color-code" style="color: ${textColor}">${color.hex}</div>`;
                }

                let fixedBadge = '';
                if (color.isMandatory) {
                    fixedBadge = '<div class="fixed-badge">ğŸ”’</div>';
                }

                card.innerHTML = `
                    <div class="color-box" style="background-color: ${color.hex}; color: ${textColor};">
                        ${fixedBadge}
                        <div class="color-info">
                            ${infoHTML}
                        </div>
                    </div>
                `;

                return card;
            }

            updateDisplay() {
                if (this.optimizer && this.optimizer.currentBestState) {
                    const fixedIndices = this.getFixedIndices();
                    this.displayResults(this.optimizer.currentBestState, fixedIndices);
                }
            }

            getFixedIndices() {
                const fixedIndices = new Set();
                for (let i = 0; i < this.optimizer.hexList.length; i++) {
                    const mard = this.optimizer.codeMaps.MARD.get(this.optimizer.hexList[i]);
                    if (this.optimizer.config.MANDATORY_MARDS.has(mard)) {
                        fixedIndices.add(i);
                    }
                }
                return fixedIndices;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const uiController = new UIController();
            window.uiController = uiController;
            uiController.init();
        });
    </script>
</body>

</html>